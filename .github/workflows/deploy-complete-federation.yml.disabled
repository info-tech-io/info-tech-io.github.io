name: Deploy Complete InfoTech.io Federation

on:
  repository_dispatch:
    types: [
      corporate-site-updated,
      quiz-docs-updated,
      hugo-docs-updated,
      web-terminal-docs-updated,
      cli-docs-updated,
      complete-federation-update
    ]
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug mode'
        type: boolean
        default: false

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages-complete-federation"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout hub repository
        uses: actions/checkout@v4

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.148.0'
          extended: true

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: Checkout hugo-templates for building
        uses: actions/checkout@v4
        with:
          repository: info-tech-io/hugo-templates
          token: ${{ secrets.PAT_TOKEN }}
          path: hugo-templates

      - name: Prepare build environment
        run: |
          echo "🏗️ Preparing complete federation build environment..."

          # Clean and create build output directory
          rm -rf build-output
          mkdir -p build-output

          # Setup hugo-templates
          cd hugo-templates
          # Initialize all submodules
          git submodule update --init --recursive
          npm install || echo "npm install failed, continuing..."
          cd ..

      # ========== STEP 1: Build Corporate Site (Root) ==========
      - name: Build Corporate Site (Root)
        run: |
          echo "🏢 Building InfoTech.io Corporate Site (Root)..."

          # Clone corporate content
          git clone https://github.com/info-tech-io/info-tech.git content-info-tech

          # Build corporate site to root
          cd hugo-templates
          chmod +x scripts/build.sh
          cp -r ../content-info-tech/docs ./module-content

          # Build with or without debug mode
          if [ "${{ github.event.inputs.debug }}" = "true" ]; then
            scripts/build.sh --config ./module-content/module.json --content ./module-content/content --output ../build-output --force --debug --verbose --no-cache
          else
            scripts/build.sh --config ./module-content/module.json --content ./module-content/content --output ../build-output --force --no-cache
          fi
          cd ..

          echo "✅ Corporate site built to root successfully!"

      # ========== STEP 2: Build All Documentation ==========
      - name: Build Quiz Engine Documentation
        run: |
          echo "📝 Building Quiz Engine Documentation..."

          # Clone quiz content
          git clone https://github.com/info-tech-io/quiz.git content-quiz

          # Build quiz docs to /docs/quiz/
          cd hugo-templates
          rm -rf ./module-content
          cp -r ../content-quiz/docs ./module-content

          # Build with or without debug mode
          if [ "${{ github.event.inputs.debug }}" = "true" ]; then
            scripts/build.sh --config ./module-content/module.json --content ./module-content/content --output ../build-output --force --debug --verbose --no-cache
          else
            scripts/build.sh --config ./module-content/module.json --content ./module-content/content --output ../build-output --force --no-cache
          fi
          cd ..

          echo "✅ Quiz Engine documentation built successfully!"

      - name: Build Hugo Templates Documentation
        run: |
          echo "🏗️ Building Hugo Templates Documentation..."

          # Clone hugo templates content
          git clone https://github.com/info-tech-io/hugo-templates.git content-hugo-templates

          # Build hugo templates docs to /docs/hugo-templates/
          cd hugo-templates
          rm -rf ./module-content
          cp -r ../content-hugo-templates/docs ./module-content

          # Build with or without debug mode
          if [ "${{ github.event.inputs.debug }}" = "true" ]; then
            scripts/build.sh --config ./module-content/module.json --content ./module-content/content --output ../build-output --force --debug --verbose --no-cache
          else
            scripts/build.sh --config ./module-content/module.json --content ./module-content/content --output ../build-output --force --no-cache
          fi
          cd ..

          echo "✅ Hugo Templates documentation built successfully!"

      - name: Build Web Terminal Documentation
        run: |
          echo "💻 Building Web Terminal Documentation..."

          # Clone web terminal content
          git clone https://github.com/info-tech-io/web-terminal.git content-web-terminal

          # Build web terminal docs to /docs/web-terminal/
          cd hugo-templates
          rm -rf ./module-content
          cp -r ../content-web-terminal/docs ./module-content

          # Build with or without debug mode
          if [ "${{ github.event.inputs.debug }}" = "true" ]; then
            scripts/build.sh --config ./module-content/module.json --content ./module-content/content --output ../build-output --force --debug --verbose --no-cache
          else
            scripts/build.sh --config ./module-content/module.json --content ./module-content/content --output ../build-output --force --no-cache
          fi
          cd ..

          echo "✅ Web Terminal documentation built successfully!"

      - name: Build Info-Tech CLI Documentation
        run: |
          echo "⚡ Building Info-Tech CLI Documentation..."

          # Clone info-tech-cli content
          git clone https://github.com/info-tech-io/info-tech-cli.git content-info-tech-cli

          # Build info-tech-cli docs to /docs/info-tech-cli/
          cd hugo-templates
          rm -rf ./module-content
          cp -r ../content-info-tech-cli/docs ./module-content

          # Build with or without debug mode
          if [ "${{ github.event.inputs.debug }}" = "true" ]; then
            scripts/build.sh --config ./module-content/module.json --content ./module-content/content --output ../build-output --force --debug --verbose --no-cache
          else
            scripts/build.sh --config ./module-content/module.json --content ./module-content/content --output ../build-output --force --no-cache
          fi
          cd ..

          echo "✅ Info-Tech CLI documentation built successfully!"

      # ========== STEP 3: Create Unified Navigation ==========
      - name: Create unified documentation hub
        run: |
          echo "🧭 Creating unified documentation hub..."

          # Ensure docs directory exists
          mkdir -p build-output/docs

          # Create comprehensive documentation index
          cat > build-output/docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="utf-8">
              <title>InfoTech.io Documentation Hub</title>
              <meta name="description" content="Comprehensive technical documentation for all InfoTech.io products">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <style>
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      margin: 0;
                      padding: 40px;
                      background: #fafafa;
                      line-height: 1.6;
                  }
                  .container {
                      max-width: 1000px;
                      margin: 0 auto;
                      background: white;
                      border-radius: 12px;
                      padding: 40px;
                      box-shadow: 0 2px 20px rgba(0,0,0,0.1);
                  }
                  .header { color: #333; margin-bottom: 20px; text-align: center; }
                  .subtitle { color: #666; margin-bottom: 40px; font-size: 18px; text-align: center; }
                  .breadcrumb {
                      color: #666;
                      margin-bottom: 20px;
                      font-size: 14px;
                  }
                  .breadcrumb a { color: #1da1f2; text-decoration: none; }
                  .breadcrumb a:hover { text-decoration: underline; }
                  .product-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                      gap: 24px;
                      margin: 40px 0;
                  }
                  .product-card {
                      border: 1px solid #e1e8ed;
                      border-radius: 8px;
                      padding: 24px;
                      transition: all 0.2s ease;
                      text-decoration: none;
                      color: inherit;
                  }
                  .product-card:hover {
                      border-color: #1da1f2;
                      transform: translateY(-2px);
                      box-shadow: 0 4px 20px rgba(29, 161, 242, 0.1);
                  }
                  .product-icon { font-size: 32px; margin-bottom: 16px; }
                  .product-title { font-size: 20px; font-weight: 600; margin-bottom: 8px; color: #333; }
                  .product-subtitle { font-size: 14px; color: #999; margin-bottom: 12px; font-family: 'Monaco', monospace; }
                  .product-description { color: #666; line-height: 1.5; margin-bottom: 16px; }
                  .product-status {
                      font-size: 12px;
                      padding: 4px 8px;
                      background: #e8f5e8;
                      color: #2e7d2e;
                      border-radius: 4px;
                      display: inline-block;
                  }
                  .footer-links {
                      margin-top: 40px;
                      padding-top: 20px;
                      border-top: 1px solid #eee;
                      color: #666;
                      text-align: center;
                  }
                  .footer-links a { color: #1da1f2; text-decoration: none; margin: 0 10px; }
                  .footer-links a:hover { text-decoration: underline; }
                  @media (max-width: 768px) {
                      body { padding: 20px; }
                      .container { padding: 20px; }
                      .product-grid { grid-template-columns: 1fr; }
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="breadcrumb">
                      <a href="/">🏠 InfoTech.io</a> → Documentation Hub
                  </div>

                  <h1 class="header">📚 Documentation Hub</h1>
                  <p class="subtitle">
                      Complete technical documentation for all InfoTech.io products and tools.<br>
                      <small>Updated automatically via GitHub Actions • Federated architecture</small>
                  </p>

                  <div class="product-grid">
                      <a href="/docs/quiz/" class="product-card">
                          <div class="product-icon">📝</div>
                          <h3 class="product-title">Quiz Engine</h3>
                          <div class="product-subtitle">Repository: quiz</div>
                          <p class="product-description">
                              Interactive testing system for creating quizzes and assessments.
                              Lightweight, embeddable, with real-time scoring and detailed analytics.
                          </p>
                          <span class="product-status">✅ Active</span>
                      </a>

                      <a href="/docs/hugo-templates/" class="product-card">
                          <div class="product-icon">🏗️</div>
                          <h3 class="product-title">Hugo Templates Factory</h3>
                          <div class="product-subtitle">Repository: hugo-templates</div>
                          <p class="product-description">
                              Advanced framework for rapid creation of Hugo-based static sites
                              with templates, components, and automated workflows.
                          </p>
                          <span class="product-status">✅ Active</span>
                      </a>

                      <a href="/docs/web-terminal/" class="product-card">
                          <div class="product-icon">💻</div>
                          <h3 class="product-title">Web Terminal</h3>
                          <div class="product-subtitle">Repository: web-terminal</div>
                          <p class="product-description">
                              Browser-based interactive terminal environment for hands-on learning.
                              Docker-powered, secure, and collaborative development environment.
                          </p>
                          <span class="product-status">✅ Active</span>
                      </a>

                      <a href="/docs/info-tech-cli/" class="product-card">
                          <div class="product-icon">⚡</div>
                          <h3 class="product-title">Info-Tech CLI</h3>
                          <div class="product-subtitle">Repository: info-tech-cli</div>
                          <p class="product-description">
                              Command-line tools for automating InfoTech.io development workflows,
                              site management, and deployment processes.
                          </p>
                          <span class="product-status">✅ Active</span>
                      </a>
                  </div>

                  <div class="footer-links">
                      <p>
                          <a href="/">🏠 Main Site</a> •
                          <a href="/products/">📦 Products</a> •
                          <a href="https://github.com/info-tech-io">🐙 GitHub</a> •
                          <a href="/open-source/">🔓 Open Source</a>
                      </p>
                      <p>
                          <small>
                              💡 <strong>Federation Architecture:</strong>
                              Each product maintains its documentation in its own repository,
                              automatically published here via CI/CD workflows.
                          </small>
                      </p>
                  </div>
              </div>
          </body>
          </html>
          EOF

          echo "✅ Unified documentation hub created!"

      # ========== STEP 4: Build Summary ==========
      - name: Complete Federation Build Summary
        run: |
          echo "🎯 Complete InfoTech.io Federation Build Summary:"
          echo "📊 Total files: $(find build-output -type f | wc -l)"
          echo "📦 Total size: $(du -sh build-output | cut -f1)"
          echo ""
          echo "🏗️ Federation Structure:"
          echo "├── / (Corporate site - $(find build-output -maxdepth 1 -name "*.html" | wc -l) pages)"
          echo "├── /docs/ (Documentation hub)"

          if [ -d "build-output/docs/quiz" ]; then
            echo "│   ├── /docs/quiz/ ($(find build-output/docs/quiz -name "*.html" 2>/dev/null | wc -l) pages)"
          fi

          if [ -d "build-output/docs/hugo-templates" ]; then
            echo "│   ├── /docs/hugo-templates/ ($(find build-output/docs/hugo-templates -name "*.html" 2>/dev/null | wc -l) pages)"
          fi

          if [ -d "build-output/docs/web-terminal" ]; then
            echo "│   ├── /docs/web-terminal/ ($(find build-output/docs/web-terminal -name "*.html" 2>/dev/null | wc -l) pages)"
          fi

          if [ -d "build-output/docs/info-tech-cli" ]; then
            echo "│   └── /docs/info-tech-cli/ ($(find build-output/docs/info-tech-cli -name "*.html" 2>/dev/null | wc -l) pages)"
          fi

          echo ""
          echo "🌐 Available URLs:"
          echo "  • Corporate: https://info-tech-io.github.io/"
          echo "  • Docs Hub: https://info-tech-io.github.io/docs/"
          echo "  • Quiz: https://info-tech-io.github.io/docs/quiz/"
          echo "  • Hugo Templates: https://info-tech-io.github.io/docs/hugo-templates/"
          echo "  • Web Terminal: https://info-tech-io.github.io/docs/web-terminal/"
          echo "  • CLI: https://info-tech-io.github.io/docs/info-tech-cli/"
          echo ""
          echo "✅ Complete InfoTech.io federation deployed successfully!"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: build-output

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4